  <!DOCTYPE html>
  <html lang="en">
  <head>
    <!-- Character encoding -->
    <meta charset="UTF-8" />

    <!-- Viewport settings for responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Page Title -->
    <title>Lossless</title> <!-- Choose a single, consistent title -->

    <!-- Main CSS stylesheet -->
    <link rel="stylesheet" href="style.css" />

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Lossless" />


    <!-- Additional metadata or head assets can go below -->
    <meta charset="utf-8" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
  </head>
    <body class="is-preload"> <!-- Client Portal HTML -->
      <!-- Wrapper -->
        <div id="wrapper">
            <header id="header"> <!-- Header -->
              <div class="content">
                <div class="inner">
                  <h2 id="greeting">loading</h2>
                  <p>welcome back</p>
                </div>
              </div>
              <nav>
                <ul>
                  <li><a href="#photo">take a photo</a></li>
                  <li><a href="#lunch">Boring stuff</a></li>
                  <li><a href="#LB">Leaderboards</a></li>
                  <li><a href="#settings">settings</a></li>
                  <!--<li><a href="#elements">Elements</a></li>-->
                </ul>
              </nav>
            </header>
            <div id="main">
            <article id="photo"> <!-- First Panel -->
                <h2 class="major">Messanger</h2>
                <div id="photoPreview" style="margin-top: 15px;">
                <h3 style="margin-top: 30px;">Chat</h3>
                <div id="chatWindow" class="chat-window"></div>
                <div class="chat-input-wrapper">
                <label for="photoUpload" class="upload-icon">
                  <svg viewBox="0 0 24 24" width="24" height="24" fill="#2196F3">
                    <circle cx="12" cy="12" r="10" fill="#2196F3"/>
                    <line x1="12" y1="8" x2="12" y2="16" stroke="#fff" stroke-width="2"/>
                    <line x1="8" y1="12" x2="16" y2="12" stroke="#fff" stroke-width="2"/>
                  </svg>
                </label>
                <input type="file" accept="image/*" id="photoUpload" style="display: none;" onchange="handleUpload()" />
                <input type="text" id="chatMessage" placeholder="Type a message..." />
                <button onclick="sendMessage()">Send</button>
              </div>
              </article>
            <article id="lunch"> <!-- Second Panel -->
              <h2 class="major">Lunch</h2>
              <div id="photoPreview" style="margin-top: 15px;">
              </div>
              </article>
            <article id="LB"> <!-- Third Panel -->
              <h2 class="major">Leadboards</h2>
              <input type="file" accept="image/*" id="photoUpload" style="margin-bottom: 10px;" />
              <button onclick="handleUpload()">Upload Photo</button>
              <div id="photoPreview" style="margin-top: 15px;">
              </div>
              </article>
            <article id="settings"> <!-- Fourth Panel -->
              <h2 class="major">Settings</h2>
              <input type="file" accept="image/*" id="photoUpload" style="margin-bottom: 10px;" />
              <button onclick="handleUpload()">Upload Photo</button>
              <div id="photoPreview" style="margin-top: 15px;">
              </div>
              </article>
            <article id="elements"> <!-- Elements -->
              <h2 class="major">Elements</h2>
              <section>
                <h3 class="major">Text</h3>
                <p>This is <b>bold</b> and this is <strong>strong</strong>. This is <i>italic</i> and this is <em>emphasized</em>.
                This is <sup>superscript</sup> text and this is <sub>subscript</sub> text.
                This is <u>underlined</u> and this is code: <code>for (;;) { ... }</code>. Finally, <a href="#">this is a link</a>.</p>
                <hr />
                <h2>Heading Level 2</h2>
                <h3>Heading Level 3</h3>
                <h4>Heading Level 4</h4>
                <h5>Heading Level 5</h5>
                <h6>Heading Level 6</h6>
                <hr />
                <h4>Blockquote</h4>
                <blockquote>Fringilla nisl. Donec accumsan interdum nisi, quis tincidunt felis sagittis eget tempus euismod. Vestibulum ante ipsum primis in faucibus vestibulum. Blandit adipiscing eu felis iaculis volutpat ac adipiscing accumsan faucibus. Vestibulum ante ipsum primis in faucibus lorem ipsum dolor sit amet nullam adipiscing eu felis.</blockquote>
                <h4>Preformatted</h4>
              </section>
            </article>
              </div>
            <div class="dot-container"> <!-- Dots -->
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
              </div>
          
              <div class="progress-container"> <!-- Dots -->
              <input type="range" min="0" max="100" value="50" />
              <p>your progress</p>
              </div>
            <!-- <span id="currentTime">Loading time...</span> <!-- Current Time -->
          <footer class="w3-display-bottommiddle w3-padding-large w3-center"> <!-- Footer -->
            <h3 href="#" onclick="signOut()" class="w3-text-white">Sign Out</h3>
            <div id="client-id-display" style="
              position: fixed;
              bottom: 10px;
              left: 50%;
              transform: translateX(-50%);
              font-size: 10px;
              z-index: 1000;
            "> Loading client ID...
            </div>
            </footer>
            </div>
      <!-- BG -->
        <div id="bg"></div>
    </body>
  <style>
      body {
        padding-top: env(safe-area-inset-top);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
        margin: 0;
      }
      body,h1 {font-family: "Raleway", sans-serif}
        .dot-container {
          display: flex;
          justify-content: center;
          margin: 40px 0;
          gap: 8px;
        }
        .dot {
          width: 10px;
          height: 10px;
          background-color: #888;
          border-radius: 50%;
          display: inline-block;
        }

  .progress-container input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 4px;
    outline: none;
    cursor: pointer;

    /* This creates the two colors on the track: green up to value, grey after */
    background: linear-gradient(
      to right,
      #4caf50 0%,
      #4caf50 var(--range-progress),
      #888 var(--range-progress),
      #888 100%
    );
  }

  /* Thumb styling */
  .progress-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 10px;
    height: 10px;
    background: #2e7d32; /* darker green */
    border-radius: 50%;
    border: 1px solid #1b5e20;
    cursor: pointer;
  }
  .progress-container input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #2e7d32;
    border-radius: 50%;
    border: 1px solid #1b5e20;
    cursor: pointer;
  }

      body, html {
        background-color: black; /* or your app bg color */
        height: 100%;
        margin: 0;
      }
      .chat-input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }
      .chat-window {
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.1); /* slightly more transparent */
        backdrop-filter: blur(10px); /* frosted glass effect */
        -webkit-backdrop-filter: blur(10px);
        padding: 15px;
        height: 250px;
        overflow-y: auto;
        margin-bottom: 10px;
        color: black;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .upload-icon {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        border-radius: 50%;
        transition: background 0.3s;
      }
      .upload-icon:hover {
        background: rgba(33, 150, 243, 0.1);
      }
      .chat-input-wrapper input[type="text"] {
        flex: 1;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 1em;
      }
      .chat-input-wrapper button {
        padding: 8px 16px;
        border: none;
        border-radius: 10px;
        background: #2196F3;
        color: white;
        cursor: pointer;
      }
      #uploadSuccessMessage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        transform: translateY(-100%);
        background-color: rgba(100, 100, 100, 0.5); /* opaque grey */
        color: white;
        padding: 14px 0;
        font-weight: bold;
        text-align: center;
        z-index: 1000;
        transition: transform 0.5s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        pointer-events: none;
      }

      /* When active, slide down */
      #uploadSuccessMessage.show {
        transform: translateY(0);
      }

  </style>
  <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
      function showUploadSuccessMessage() {
  let msg = document.getElementById("uploadSuccessMessage");
  if (!msg) {
    msg = document.createElement("div");
    msg.id = "uploadSuccessMessage";
    msg.textContent = "Upload successful!";
    document.body.appendChild(msg);
  }

  // Trigger slide down by adding 'show' class
  msg.classList.add("show");

  // Clear any previous timers
  if (msg._hideTimeout) clearTimeout(msg._hideTimeout);
  if (msg._removeTimeout) clearTimeout(msg._removeTimeout);

  // After 3 seconds, slide back up
  msg._hideTimeout = setTimeout(() => {
    msg.classList.remove("show");
  }, 3000);

  // After slide up transition (0.5s), remove the message from DOM
  msg._removeTimeout = setTimeout(() => {
    if (msg.parentNode) {
      msg.parentNode.removeChild(msg);
    }
  }, 3500);
}

  // Show preview
    const reader = new FileReader();
    reader.onload = function (e) {
      previewDiv.innerHTML = `
        <p><strong>Time of Day:</strong> Breakfast</p>
        <img src="${e.target.result}" alt="Uploaded photo" style="max-width: 100%; height: auto; border: 1px solid #ccc; padding: 5px;" />
      `;
    };
    const slider = document.querySelector('.progress-container input[type="range"]');

    function updateSliderBackground() {
      const value = slider.value;
      slider.style.setProperty('--range-progress', `${value}%`);
    }

    // Initialize on page load
    updateSliderBackground();

    // Update on input change
    slider.addEventListener('input', updateSliderBackground);
    // Get stored username from sessionStorage or set a fallback
    const username = sessionStorage.getItem('username') || 'there';
    // Capitalize first letter (optional)
    const displayName = username.charAt(0).toUpperCase() + username.slice(1);
    // Update greeting text
    const greetingEl = document.getElementById('greeting');
      if (greetingEl) {
        greetingEl.textContent = `Hey ${displayName} 👋`;
      }
    document.addEventListener('DOMContentLoaded', () => {
      const clientId = sessionStorage.getItem('clientId'); // Show client ID from sessionStorage
      const display = document.getElementById('client-id-display');
      if (clientId) {
        display.textContent = "Client ID: " + clientId;
      } else {
        display.textContent = "Client ID not found.";
      }

      function updateTime() { // Update clock every second
        const now = new Date();
        const formatted = now.toLocaleTimeString();
        document.getElementById('currentTime').textContent = `Current Time: ${formatted}`;
        }
        updateTime();
        setInterval(updateTime, 1000);
        });


async function getPresignedUrl(clientHash, originalFilename) {
  function generateS3Key(filename) {
    const now = new Date();
    const hour = now.getHours().toString().padStart(2, '0');
    const minutes = '00'; // fixed zero minutes for simplicity
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    const month = monthNames[now.getMonth()];
    const day = now.getDate();

    let ext = '';
    if (filename && filename.lastIndexOf('.') !== -1) {
      ext = filename.substring(filename.lastIndexOf('.'));
    }
    return `${hour}_${minutes}_${month}_${day}${ext}`;
  }

  // Compose full key: clientHash folder + generated file name
  const s3Key = `${clientHash}/${generateS3Key(originalFilename)}`;

  const response = await fetch("https://hq17bpo4h9.execute-api.us-east-2.amazonaws.com/dev/upload", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      clientHash: clientHash,
      action: "photoupload",
      key: s3Key  // pass the generated S3 key here
    })
  });

  const text = await response.text();
  const parsed = JSON.parse(text);

  return parsed.uploadUrl;
}

async function handleUpload() {
  const fileInput = document.getElementById("photoUpload");
  const chatWindow = document.getElementById("chatWindow");
  if (fileInput.files.length === 0) {
    alert("Please choose a photo first.");
    return;
  }

  const file = fileInput.files[0];
  const clientHash = sessionStorage.getItem("clientId");
  // alert(clientHash); // optional, for debugging

  // Show the image immediately in chat window (local preview)
  const imgDiv = document.createElement("div");
  imgDiv.style.marginBottom = "5px";
  imgDiv.style.padding = "6px 10px";
  imgDiv.style.borderRadius = "8px";
  imgDiv.style.background = "#e0f7fa";
  imgDiv.style.alignSelf = "flex-start";

  const img = document.createElement("img");
  img.src = URL.createObjectURL(file);
  img.style.maxWidth = "150px";
  img.style.borderRadius = "10px";
  img.style.display = "block";

  imgDiv.appendChild(img);
  chatWindow.appendChild(imgDiv);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  // Then upload the image to your backend as you do now
  const presignedUrl = await getPresignedUrl(clientHash, file.name);

  const uploadResponse = await fetch(presignedUrl, {
    method: "PUT",
    headers: {
      "Content-Type": file.type
    },
    body: file
  });

  if (!uploadResponse.ok) {
    alert(`Upload failed with status ${uploadResponse.status}`);
    // Optionally remove the preview if upload fails
    chatWindow.removeChild(imgDiv);
    return;
  }

  showUploadSuccessMessage();
  // Optionally revoke the object URL after upload to free memory
  URL.revokeObjectURL(img.src);
}


    // Messages
    async function sendMessage() {
      const messageInput = document.getElementById("chatMessage");
      const chatWindow = document.getElementById("chatWindow");
      const message = messageInput.value.trim();
      if (!message) return;
      // Display user message
      const userDiv = document.createElement("div");
      userDiv.textContent = message;
      userDiv.style.marginBottom = "5px";
      userDiv.style.padding = "6px 10px";
      userDiv.style.borderRadius = "8px";
      userDiv.style.background = "#e0f7fa";
      userDiv.style.alignSelf = "flex-start";
      chatWindow.appendChild(userDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      messageInput.value = "";
      // Placeholder for streaming response
      const responseDiv = document.createElement("div");
      responseDiv.textContent = "";
      responseDiv.style.marginBottom = "5px";
      responseDiv.style.padding = "6px 10px";
      responseDiv.style.borderRadius = "8px";
      responseDiv.style.background = "#fff9c4";
      responseDiv.style.alignSelf = "flex-end";
      chatWindow.appendChild(responseDiv);
      // Call backend API streaming response
      try {
        const res = await fetch("/api/stream-response", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        if (!res.body) {
          responseDiv.textContent = "No response body from server.";
          return;
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        while (!done) {
          const { value, done: readerDone } = await reader.read();
          if (value) {
            const chunk = decoder.decode(value, { stream: true });
            responseDiv.textContent += chunk;
            chatWindow.scrollTop = chatWindow.scrollHeight;
          }
          done = readerDone;
        }
      } catch (error) {
        responseDiv.textContent = "Error fetching response.";
        console.error(error);
      }
    }
    function signOut() {
        sessionStorage.clear(); // Delete all session data
      window.location.href = "index.html"; // Redirect to home
    }
    </script>
  </html>
